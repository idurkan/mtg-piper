import datetime
import os
import itertools
import logging
import json
import re
import subprocess
import sys
import traceback
import pprint

logging.basicConfig(level=logging.DEBUG)
log = logging.getLogger()

def _query_tutor(command_parameters):
    """
    :param command_parameters:
    :return: the json-parsed output of the tutor command
    """

    command = ['tutor', '--format', 'json'] + command_parameters

    try:
        return json.loads(subprocess.check_output(command).strip())
    except (subprocess.CalledProcessError, ValueError) as e:
        raise subprocess.CalledProcessError(u'problem with command',
                                            u' '.join(command))

def query_cards_with_ids(card_ids):
    set_cards = []

    for card_id in card_ids:
        card = _query_tutor(['card', card_id])
        card['id'] = card_id
        set_cards.append(card)

    return set_cards

def write_cards_with_ids_to_file(card_ids):
    all_cards_dict = {}
    all_lands = query_cards_with_ids(card_ids[0:5])

    lands_id_dict = card_postprocessing(all_lands)

    json.dump(lands_id_dict, open('lands.json', 'wb'), indent=4, sort_keys=True, separators=(',', ': '))

url_breaker = re.compile(r"(.*)=(\d+$)")

def card_postprocessing(cards):
    errored_cards = []
    set_id_dict = {}

    for card in cards:
        card['special_card'] = 'normal'
        set_id_dict[card['id']] = card

    return set_id_dict

def main(args):
    land_ids = get_land_ids()

    start_time = get_time_now()
    print('Started scrape at: ' + str(start_time))

    write_cards_with_ids_to_file(land_ids)

    end_time = get_time_now()
    print('***************************************************')
    print('Finished scrape at: ' + str(end_time))
    print('Total elapsed time: ' + str(end_time - start_time))
    print('***************************************************')

def get_time_now():
    return datetime.datetime.now().replace(microsecond=0)

# I semi-manually figured out the IDs of all English-language lands.
def get_land_ids():
    # plains
    plains_ids = ['294',
        '295',
        '597',
        '595',
        '596',
        '899',
        '897',
        '898',
        '1396',
        '1395',
        '1397',
        '2384',
        '2386',
        '2385',
        '4203',
        '4205',
        '4204',
        '4206',
        '14736',
        '14734',
        '14735',
        '14733',
        '11448',
        '11449',
        '11446',
        '11447',
        '46438',
        '46440',
        '46439',
        '46437',
        '83207',
        '83208',
        '83209',
        '83210',
        '129680',
        '129682',
        '129683',
        '129681',
        '191395',
        '191382',
        '191396',
        '191385',
        '213615',
        '213614',
        '213612',
        '213613',
        '244333',
        '244334',
        '244331',
        '244332',
        '249734',
        '249733',
        '249731',
        '249732',
        '2771',
        '2772',
        '2773',
        '3585',
        '3587',
        '3586',
        '3588',
        '4955',
        '4953',
        '4954',
        '4956',
        '8325',
        '8324',
        '8323',
        '8322',
        '20883',
        '20882',
        '20880',
        '20881',
        '26298',
        '26299',
        '25963',
        '26300',
        '31630',
        '31612',
        '31629',
        '31631',
        '40124',
        '40123',
        '40122',
        '40121',
        '48407',
        '48406',
        '48408',
        '48409',
        '79072',
        '79060',
        '79063',
        '79076',
        '95112',
        '95108',
        '95115',
        '95105',
        '122087',
        '122084',
        '122085',
        '122092',
        '143621',
        '143630',
        '143620',
        '143622',
        '158236',
        '157887',
        '157873',
        '158235',
        '21789',
        '21790',
        '21792',
        '21791',
        '25454',
        '25453',
        '22362',
        '22358',
        '22359',
        '22361',
        '22357',
        '22363',
        '22356',
        '22360',
        '21145',
        '195163',
        '201971',
        '201972',
        '195179',
        '195173',
        '201974',
        '201973',
        '195196',
        '4425',
        '4427',
        '4426',
        '4428',
        '8354',
        '8374',
        '8380',
        '205925',
        '205928',
        '205931',
        '205938',
        '10646',
        '10581',
        '10645',
        '9680',
        '73963',
        '175029',
        '175032',
        '175031',
        '175030',
        '221309',
        '221310',
        '249376',
        '284498',
        '284499',
        '284497',
        '222753',
        '222751',
        '222752',
        '222754',
        '243458',
        '243457',
        '243456',
        '243459',
        '227552',
        '227518',
        '249813',
        '249814',
        '249815',
        '249812',
        '210513',
        '214683',
        '214677',
        '214679',
        '214671',
        '220366',
        '214057',
        '269634',
        '269638',
        '269637',
        '245230',
        '245231',
        '245233',
        '289310',
        '289309',
        '289311',
        '289312',
        '333721',
        '159288',
        '159287',
        '159289',
        '205436',
        '205440',
        '205428',
        '205430',
        '205301',
        '276461',
        '276469',
        '276473',
        '276459',
        '276458',
        '368473',
        '368480',
        '368508',
        '370615',
        '370669',
        '370679',
        '370754',
        '373341',
        '373361',
        '373369',
        '373386',
        '373533',
        '373582',
        '373654',
        '373700',
        '376451',
        '376452',
        '376453',
        '376454',
        '206079',
        '206080',
        '206078',
        '197256',
        '197253',
        '197255',
        '197254',
        '207937']

    # islands
    island_ids = ['292',
        '293',
        '592',
        '593',
        '594',
        '896',
        '894',
        '895',
        '1394',
        '1392',
        '1393',
        '2391',
        '2389',
        '2390',
        '4201',
        '4202',
        '4200',
        '4199',
        '14740',
        '14737',
        '14738',
        '14739',
        '11349',
        '11351',
        '11348',
        '11350',
        '46442',
        '46443',
        '46441',
        '46444',
        '83137',
        '83138',
        '83136',
        '83139',
        '129608',
        '129607',
        '129606',
        '129609',
        '191400',
        '191387',
        '191389',
        '191390',
        '213619',
        '213618',
        '213616',
        '213617',
        '244325',
        '244326',
        '244324',
        '244323',
        '249723',
        '249724',
        '249725',
        '249726',
        '2767',
        '2769',
        '2768',
        '3582',
        '3583',
        '3584',
        '3581',
        '4949',
        '4951',
        '4950',
        '4952',
        '8326',
        '8329',
        '8328',
        '8327',
        '20886',
        '20887',
        '20884',
        '20885',
        '26301',
        '25964',
        '26302',
        '26303',
        '31616',
        '31614',
        '31615',
        '31613',
        '40119',
        '40120',
        '40118',
        '40117',
        '48411',
        '48410',
        '48412',
        '48413',
        '79071',
        '79074',
        '79061',
        '79069',
        '95107',
        '95103',
        '95113',
        '95100',
        '122095',
        '122089',
        '122077',
        '118905',
        '143619',
        '143632',
        '143624',
        '143628',
        '158237',
        '157875',
        '157883',
        '157874',
        '21794',
        '21793',
        '21800',
        '21795',
        '25452',
        '25451',
        '22367',
        '21144',
        '22364',
        '22365',
        '22366',
        '27238',
        '27237',
        '27236',
        '195170',
        '195165',
        '201966',
        '201964',
        '201963',
        '201965',
        '195187',
        '195161',
        '4424',
        '4422',
        '4421',
        '4423',
        '205939',
        '205944',
        '205945',
        '205932',
        '8391',
        '8387',
        '8390',
        '10642',
        '10551',
        '10641',
        '9677',
        '73951',
        '174979',
        '174977',
        '174980',
        '174978',
        '227505',
        '227530',
        '249805',
        '249807',
        '249806',
        '249804',
        '221301',
        '221300',
        '221302',
        '284490',
        '284492',
        '284491',
        '259287',
        '222725',
        '222726',
        '222727',
        '222724',
        '214682',
        '214672',
        '214678',
        '214666',
        '220369',
        '220365',
        '210511',
        '245235',
        '245237',
        '245236',
        '269639',
        '269633',
        '269625',
        '289313',
        '289315',
        '289314',
        '289316',
        '333719',
        '190589',
        '190590',
        '190588',
        '190583',
        '159281',
        '159283',
        '159282',
        '205288',
        '205289',
        '205287',
        '205286',
        '276462',
        '276453',
        '276466',
        '276471',
        '276452',
        '292765',
        '292763',
        '292766',
        '292764',
        '370608',
        '370611',
        '370647',
        '370773',
        '373558',
        '373595',
        '373723',
        '373736',
        '376373',
        '376374',
        '376375',
        '376376',
        '206074',
        '206072',
        '206073',
        '207935']

    # swamps
    swamp_ids = ['278',
        '277',
        '574',
        '575',
        '573',
        '876',
        '875',
        '877',
        '1373',
        '1375',
        '1374',
        '2375',
        '2376',
        '2374',
        '4167',
        '4170',
        '4169',
        '4168',
        '14741',
        '14743',
        '14744',
        '14742',
        '11524',
        '11523',
        '11522',
        '11521',
        '46448',
        '46446',
        '46447',
        '46445',
        '83288',
        '83290',
        '83291',
        '83289',
        '129757',
        '129754',
        '129756',
        '129755',
        '191391',
        '191398',
        '191381',
        '191399',
        '213623',
        '213622',
        '213620',
        '213621',
        '244335',
        '244338',
        '244337',
        '244336',
        '249739',
        '249740',
        '249737',
        '249738',
        '2745',
        '2743',
        '2744',
        '3563',
        '3562',
        '3565',
        '3564',
        '4925',
        '4922',
        '4923',
        '4924',
        '8332',
        '8333',
        '8330',
        '8331',
        '20890',
        '20888',
        '20889',
        '20891',
        '26305',
        '26306',
        '26304',
        '25965',
        '31619',
        '31617',
        '31618',
        '31620',
        '40114',
        '40113',
        '40111',
        '40112',
        '48414',
        '48415',
        '48416',
        '48425',
        '79073',
        '79066',
        '79065',
        '79067',
        '95111',
        '95114',
        '95101',
        '95110',
        '122076',
        '122078',
        '118903',
        '118904',
        '143634',
        '143629',
        '143636',
        '143635',
        '157886',
        '157871',
        '158239',
        '157889',
        '21797',
        '21798',
        '21799',
        '21796',
        '25479',
        '25478',
        '22368',
        '22369',
        '22370',
        '21171',
        '27235',
        '27234',
        '27233',
        '195159',
        '195157',
        '201976',
        '201977',
        '201975',
        '201978',
        '195172',
        '195194',
        '204970',
        '204968',
        '204971',
        '204969',
        '4411',
        '4409',
        '4412',
        '4410',
        '205942',
        '205940',
        '205941',
        '205948',
        '8392',
        '8393',
        '8394',
        '10648',
        '10607',
        '10647',
        '9676',
        '73973',
        '175089',
        '175088',
        '175091',
        '175090',
        '221312',
        '221311',
        '221313',
        '227521',
        '227519',
        '249819',
        '249816',
        '249817',
        '249818',
        '259283',
        '262652',
        '214676',
        '214684',
        '214669',
        '214674',
        '220367',
        '220368',
        '210505',
        '210508',
        '210507',
        '210506',
        '245239',
        '245240',
        '245241',
        '269627',
        '269631',
        '269641',
        '289319',
        '289320',
        '289318',
        '333722',
        '289317',
        '159290',
        '159291',
        '159292',
        '205309',
        '205442',
        '205434',
        '205443',
        '205446',
        '276455',
        '276472',
        '276457',
        '276448',
        '276463',
        '368482',
        '368484',
        '368492',
        '368494',
        '368497',
        '368538',
        '370703',
        '370727',
        '370731',
        '370785',
        '373567',
        '373608',
        '373681',
        '373706',
        '376533',
        '376534',
        '376535',
        '376536',
        '292962',
        '292961',
        '292960',
        '292963',
        '270475',
        '270476',
        '270474',
        '270473',
        '206081',
        '206082',
        '206083',
        '197257',
        '197260',
        '197258',
        '197259',
        '207938']

    # forests
    forest_ids =['289',
        '288',
        '588',
        '586',
        '587',
        '889',
        '888',
        '890',
        '1387',
        '1386',
        '1388',
        '2379',
        '2378',
        '2377',
        '4172',
        '4173',
        '4171',
        '4174',
        '14752',
        '14751',
        '14749',
        '14750',
        '11289',
        '11288',
        '11286',
        '11287',
        '46454',
        '46455',
        '46456',
        '46453',
        '83092',
        '83095',
        '83094',
        '83093',
        '129559',
        '129562',
        '129561',
        '129560',
        '191406',
        '191407',
        '191405',
        '191409',
        '213630',
        '213631',
        '213628',
        '213629',
        '244320',
        '244321',
        '244319',
        '244322',
        '249720',
        '249718',
        '249719',
        '249721',
        '2747',
        '2748',
        '2746',
        '3566',
        '3568',
        '3567',
        '3569',
        '4928',
        '4927',
        '4929',
        '4926',
        '8338',
        '8341',
        '8340',
        '8339',
        '20896',
        '20897',
        '20899',
        '20898',
        '26312',
        '26311',
        '26310',
        '25967',
        '31627',
        '31628',
        '31625',
        '31626',
        '40106',
        '40115',
        '40116',
        '40105',
        '48424',
        '48421',
        '48422',
        '48423',
        '79078',
        '79068',
        '79062',
        '79079',
        '95098',
        '95097',
        '95106',
        '95099',
        '122088',
        '118906',
        '118927',
        '122083',
        '143625',
        '143633',
        '143617',
        '143618',
        '157877',
        '158241',
        '157870',
        '158242',
        '21805',
        '21808',
        '21806',
        '21807',
        '25482',
        '25483',
        '22351',
        '22347',
        '22354',
        '22348',
        '21119',
        '22355',
        '22353',
        '22349',
        '22352',
        '27242',
        '27243',
        '27244',
        '201962',
        '201960',
        '195158',
        '195183',
        '201961',
        '195177',
        '201959',
        '195192',
        '204965',
        '204966',
        '204964',
        '204967',
        '4413',
        '4416',
        '4414',
        '4415',
        '205933',
        '205927',
        '205935',
        '205949',
        '8408',
        '8410',
        '8409',
        '10532',
        '10639',
        '10640',
        '9683',
        '73946',
        '174930',
        '174927',
        '174928',
        '174929',
        '243461',
        '243463',
        '243462',
        '243460',
        '230081',
        '230071',
        '249802',
        '249803',
        '249800',
        '249801',
        '221295',
        '221297',
        '221296',
        '262651',
        '259285',
        '214673',
        '214680',
        '214665',
        '214670',
        '214031',
        '214075',
        '210509',
        '210510',
        '245247',
        '245248',
        '245246',
        '269636',
        '269635',
        '269629',
        '289327',
        '289325',
        '333718',
        '289328',
        '289326',
        '157948',
        '157946',
        '159041',
        '159042',
        '159279',
        '159278',
        '159280',
        '205467',
        '205464',
        '205279',
        '205465',
        '205466',
        '276464',
        '276456',
        '276454',
        '276460',
        '276468',
        '276467',
        '370598',
        '370729',
        '370756',
        '370771',
        '373349',
        '373374',
        '373375',
        '373404',
        '373568',
        '373615',
        '373625',
        '373688',
        '376340',
        '376341',
        '376342',
        '376343',
        '292943',
        '292946',
        '292945',
        '292944',
        '206069',
        '206071',
        '206070',
        '207934']

    # mountains
    mountain_ids = ['291',
        '290',
        '591',
        '590',
        '589',
        '891',
        '893',
        '892',
        '1391',
        '1390',
        '1389',
        '2383',
        '2382',
        '2381',
        '4197',
        '4198',
        '4195',
        '4196',
        '14745',
        '14747',
        '14746',
        '14748',
        '11412',
        '11413',
        '11411',
        '11410',
        '46452',
        '46451',
        '46450',
        '46449',
        '83179',
        '83176',
        '83177',
        '83178',
        '129652',
        '129649',
        '129651',
        '129650',
        '191401',
        '191402',
        '191404',
        '191403',
        '213625',
        '213627',
        '213624',
        '213626',
        '249730',
        '249729',
        '249727',
        '249728',
        '244328',
        '244329',
        '244327',
        '244330',
        '983',
        '2763',
        '2764',
        '2765',
        '3578',
        '3580',
        '3579',
        '3577',
        '4945',
        '4946',
        '4947',
        '4948',
        '8336',
        '8334',
        '8337',
        '8335',
        '20894',
        '20893',
        '20892',
        '20895',
        '26309',
        '26308',
        '25966',
        '26307',
        '31622',
        '31621',
        '31623',
        '31624',
        '40107',
        '40109',
        '40110',
        '40108',
        '48420',
        '48418',
        '48417',
        '48419',
        '79075',
        '79070',
        '79064',
        '79077',
        '95096',
        '95109',
        '95102',
        '95104',
        '122090',
        '122080',
        '118926',
        '118921',
        '143626',
        '143627',
        '143631',
        '143623',
        '157888',
        '157885',
        '157882',
        '158240',
        '21803',
        '21801',
        '21804',
        '21802',
        '25481',
        '25480',
        '22335',
        '22344',
        '22342',
        '22340',
        '21118',
        '22336',
        '22343',
        '22339',
        '22334',
        '27239',
        '27240',
        '27241',
        '201970',
        '201969',
        '201968',
        '201967',
        '195178',
        '195171',
        '195181',
        '195184',
        '4420',
        '4418',
        '4417',
        '4419',
        '205923',
        '205926',
        '205947',
        '205937',
        '8407',
        '8406',
        '8395',
        '10644',
        '10643',
        '10563',
        '9707',
        '73958',
        '175018',
        '175019',
        '175017',
        '175020',
        '259286',
        '259284',
        '284495',
        '284494',
        '284493',
        '284496',
        '221305',
        '221304',
        '221303',
        '243497',
        '243495',
        '243496',
        '243498',
        '230064',
        '227507',
        '249809',
        '249810',
        '249811',
        '249808',
        '210512',
        '214681',
        '214675',
        '214668',
        '214667',
        '214045',
        '214066',
        '269622',
        '269630',
        '269632',
        '245242',
        '245245',
        '245243',
        '289322',
        '289321',
        '333720',
        '289323',
        '289324',
        '157941',
        '157939',
        '159061',
        '157940',
        '190585',
        '190584',
        '190586',
        '190587',
        '159286',
        '159285',
        '159284',
        '205435',
        '205292',
        '205468',
        '205441',
        '205447',
        '205469',
        '205471',
        '205470',
        '205432',
        '368500',
        '368502',
        '368512',
        '370583',
        '370588',
        '370591',
        '370725',
        '373346',
        '373359',
        '373378',
        '373382',
        '373387',
        '373392',
        '373403',
        '373411',
        '373546',
        '373609',
        '373683',
        '373746',
        '376416',
        '376417',
        '376418',
        '376419',
        '276465',
        '276447',
        '276449',
        '276470',
        '292769',
        '292767',
        '292768',
        '292770',
        '206077',
        '206075',
        '206076',
        '234739',
        '234738',
        '234741',
        '234740',
        '207936']

    return plains_ids + island_ids + swamp_ids + forest_ids + mountain_ids

if __name__ == '__main__':
    main(sys.argv[1:])
